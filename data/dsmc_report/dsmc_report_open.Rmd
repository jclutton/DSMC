---
title: "Title"
author: "Authors"
output:
  word_document:
    toc: TRUE
    reference_docx: style_template.docx
---

```{r setup, include=FALSE}
##### Declare Libraries #####
library(rio)
library(tidyverse)
library(flextable)
library(gtsummary)
library(officedown)
library(officer)


#### Directories ####
if(Sys.info()['user']=="vidon"){ #Eric's computer
  root <- file.path('Z:')
  user <- 'Eric'
} else if(Sys.info()['sysname']=="Windows"){ #Jon's computer
  root <- file.path('P:')
  user <- 'Jon'
} else {
  error("This drive has not been set up yet.")
}

drive_dir <- file.path(root,'IRB_STUDY0011132_Cohort','RIS_code')

project_dir <- file.path(drive_dir,'BOLD_dsmc')
  script_dir <- file.path(project_dir,'R')
  data_dir <- file.path(project_dir,'data')
    raw_data_dir <- file.path(data_dir,'raw')
    output_data_dir <- file.path(data_dir,'output')
    dsmc_dir <- file.path(data_dir,'dsmc_report')
      ppt_destination <- file.path(dsmc_dir,'tables_as_ppt')

 ###.Rdata Info####
data_date <- file.info(file.path(output_data_dir,'clean_data.Rdata')) %>%
  select(mtime) %>%
  mutate(mtime = format(mtime - days(1), '%b. %d, %Y')) %>%
  pull()  
    
###### Load Data #####
load(file.path(output_data_dir,'clean_data.Rdata'))

##### COMET database (test entry removed) ######
status_to_join <- look_up_table %>%
      filter(field == "intervention_status") %>%
      rename(Status = id_name) %>%
      select(-field)
    
bold <- bold %>%
  left_join(., status_to_join, by = c('intervention_status'='id_num')) 


###### import ctcae categories and terms #######
ctcae_categories <- import(file.path(data_dir,'dsmc_report','CTCAE_v5.0_categories.xlsx'))
ctcae_terms <- import(file.path(data_dir,'dsmc_report','CTCAE_v5.0_terms.xlsx'))

#### Adverse Event and EOI Databases ######
#'20230822: Changed ctcae_term to be ae_event (the short description) if it's an "other" ctcae term. Check with team if they like that. JC
#'
ae_outcome_to_join <- look_up_table %>%
  filter(field == "ae_outcome_2") %>%
  select(-field)

ae_master <- redcap %>%
  filter(!is.na(ae_date)) %>%
  mutate(Related = case_when(ae_related == 0 ~ "Not Related",
                             ae_related == 2 ~ "Possibly Related",
                             ae_related == 1 ~ "Definitely Related")) %>%
  left_join(., ctcae_categories, by = c("ae_ctcae_category" = "ctcae_identifier")) %>%
  left_join(., ctcae_terms, by = c("ae_ctcae_term" = "ctcae_term_identifier")) %>%
  mutate(ctcae_term = case_when(grepl("Other",ctcae_term,ignore.case=T) & str_length(ae_ctcase_term_oth) <= 50 ~ ae_ctcase_term_oth,
                                T ~ ctcae_term)) %>%
  mutate("SOC and Preferred Term" = case_when(!grepl("Other", ctcae_term) ~ paste(ctcae_category,"-",ctcae_term),
                                              TRUE ~ ctcae_term)) %>%
  left_join(., ae_outcome_to_join, by = c('ae_outcome_2'='id_num')) %>%
  rename("Outcome" = "id_name") %>%
  mutate(Serious = case_when(ae_was_ae_serious == 0 ~ "No",
                             ae_was_ae_serious == 1 ~ "Yes")) %>%
  mutate(Severity = case_when(ae_severity == 1 ~ "Grade 1; Mild",
                              ae_severity == 2 ~ "Grade 2; Moderate",
                              ae_severity == 3 ~ "Grade 3; Severe",
                              ae_severity == 4 ~ "Grade 4; Life Threatening",
                              ae_severity == 5 ~ "Grade 5; Death related to AE")) %>%
  mutate(ctcae_term = case_when(grepl("covid",ctcae_term,ignore.case=T) ~ "COVID-19",
                                T ~ ctcae_term)) 


##### import recruitment projections ####
recruitment_projection <- import(file.path(data_dir,'codebooks','recruitment_projection.xlsx')) %>%
  mutate(week = week(ymd(Date)), year = year(ymd(Date)))

##### Source consort diagram to use throughout document ####
source(file.path(data_dir,'dsmc_report','dsmc_consort_generator_open.R'))

###### Date as of Report ####
date_as_of <- data_date

###### Last Report ######
date_of_last_report <- ymd('2023-02-08')

#### date of first screen ####
first_screen <- min(ymd(bold$scrn_date), na.rm = T)-1

#### Set Semester months ####
semester_1 <- semesters$semester_1
semester_2 <- semesters$semester_2
year(today())

last_semester_2_date <- ymd(paste0(year(today()),
                              str_pad(as.character(first(semester_1)), side = "left", pad = "0", width = 2),
                              "01")) - 1
semester_2_string <- paste0(str_pad(as.character(month(last_semester_2_date)), side = "left", pad = "0", width = 2),
                            day(last_semester_2_date))

last_semester_1_date <- ymd(paste0(year(today()),
                              str_pad(as.character(first(semester_2)), side = "left", pad = "0", width = 2),
                              "01")) - 1
semester_1_string <- paste0(str_pad(as.character(month(last_semester_1_date)), side = "left", pad = "0", width = 2),
                                                 day(last_semester_1_date))


#### Testing PPTX Export ####
#' adding on 20230921
#' Paths to the two files
template_file <- file.path(ppt_destination,"template.pptx")
tbl_file <- file.path(ppt_destination,"tables.pptx")

#Create a blank file each time script is run so that tables don't keep getting added over and over again
file.copy(from = template_file,
          to = tbl_file,
          overwrite = T)
#Find size of slide
sl_size <- read_pptx(tbl_file) %>% 
  slide_size()

#Write function to add table to slide to be used throughout script
add_table <- function(table){
  
  ft_dim <- flextable_dim(table)
  left <- (sl_size$width/2) - (ft_dim$widths/2)
  top <- (sl_size$height/2) - (ft_dim$heights/2)
  
  tables <- read_pptx(tbl_file) %>%
    add_slide(.,
              layout = "Blank",
              master = "Office Theme") %>%
    ph_with(., 
            value = table,
            location = ph_location(left = left, top = 0))
  
  print(tables,
        target = file.path(ppt_destination,'tables.pptx'))
  
}





```


\newpage

# Protocol Synopsis

Edit here for protocol synopsis

\newline

## Project Organizational Chart, Personnel

The org chart file can be found here `r file.path(data_dir,'dsmc_report','org_chart.xlsx')`. Please edit and save the file to update. 

```{r org_chart, echo=FALSE, warning=FALSE, message=FALSE}

org_chart <- import(file.path(data_dir,'dsmc_report','org_chart.xlsx')) %>%
  arrange(Role)

flextable(org_chart) %>%
  theme_box(.) %>%
  set_table_properties(., layout = "autofit", width = 1)


```

\newpage

## Brief Statement of Purpose of Trial

Please add the purpose below to fit the needs of the BOLD project. 


\newline

## Projected Timetable and Schedule

To import a project timeline, save a .png file over this file: `r file.path(data_dir,'dsmc_report','project_timeline.png')`
```{r project_timetable, echo=FALSE, warning=FALSE, message=FALSE}


knitr::include_graphics(file.path(data_dir,'dsmc_report','project_timeline.png'), dpi = 6.25) 


```

\newpage

# Recruitment and Participant Status: Figures and Tables

\newpage

## Figure 1a: Screening Consort Diagram

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

Recruitment start date: Sept 09, 2021

```{r consorta, echo=FALSE, warning=FALSE, message=FALSE}



knitr::include_graphics(file.path(data_dir,'dsmc_report','open_consort_screen.png'), dpi = 6.92) 

```

\newpage

## Figure 1b: Enrollment Consort Diagram

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

Recruitment start date: Sept 09, 2021

```{r consortb, echo=FALSE, warning=FALSE, message=FALSE}



knitr::include_graphics(file.path(data_dir,'dsmc_report','open_consort_enrolled.png'), dpi = 6.92) 

```

\newpage

## Figure 2: Enrollment: Actual vs. Expected

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r recruitment_graph, echo=FALSE, warning=FALSE, message=FALSE}

######Dataframe on enrollment targets ###### 
target <- recruitment_projection %>%
  mutate(week = isoweek(Date), year = isoyear(Date)) %>%
  select(week, year, `Enrollment Goal by Week`, Date, `Screen Goal by Week`) %>%
  arrange(year, week)%>%
  mutate(`Enrollment Target` = cumsum(`Enrollment Goal by Week`),
         `Screening Target` = cumsum(`Screen Goal by Week`))


###### Dataframe on enrollment ###### 
enrolled <- bold %>%
  mutate(week = isoweek(rand_date), year = year(rand_date)) %>%
  arrange(year, week) %>%
  group_by(week, year) %>%
  count() %>%
  ungroup() %>%
  filter(!is.na(year)) %>%
  as_tibble(.) %>%
  arrange(year, week) %>%
  mutate(Enrolled = cumsum(n))

###### Graph parameters for milestones #####
ms_pct <- c(25,50,75,100)
params <- data.frame(ms_pct,
                     milestone = 280*(ms_pct/100),
                     milestone_screen = 3*280*(ms_pct/100),
                     xend = as.POSIXct(c(rep(NA,4))),
                     xend2 = as.POSIXct(c(rep(NA,4))))

for(i in 1:nrow(params)){
  params$xend[i]  <- target$Date[which.max(target$`Enrollment Target` >= params$milestone[i])]
  params$xend2[i] <- target$Date[which.max(target$`Screening Target` >= params$milestone_screen[i])]
}

###### Graph of Enrollment #####
enrollment_projection <- left_join(target, enrolled) %>%
  select(week, year, Enrolled, `Enrollment Target`, Date) %>%
 # filter(Date > "2021-09-27" & Date < "2025-03-31") %>%
  pivot_longer(., cols=-c(week,year, Date)) %>%
  arrange(name, Date) %>%
  rename(., Accrual = 'name',
         Counts = 'value') %>%
  filter(!is.na(Counts)) %>%
  as_tibble() %>%
  ggplot() +
  geom_line(aes(y=Counts, x=Date, group=Accrual, linetype=Accrual, col = Accrual), lwd = 1.5) +
  scale_linetype_manual(values=c("solid",'longdash')) +
  scale_color_manual(values=c("black","gray")) +
  scale_y_continuous(limits = c(0, 300), breaks=seq(0,300,50), expand = c(0, 0)) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[1], y=params$milestone[1], yend=params$milestone[1]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone[1]+5, label=paste0(params$ms_pct[1],"% Enrollment Milestone"), color="black", size=4) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[2], y=params$milestone[2], yend=params$milestone[2]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone[2]+5, label=paste0(params$ms_pct[2],"% Enrollment Milestone"), color="black", size=4) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[3], y=params$milestone[3], yend=params$milestone[3]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone[3]+5, label=paste0(params$ms_pct[3],"% Enrollment Milestone"), color="black", size=4) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[4], y=params$milestone[4], yend=params$milestone[4]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone[4]+5, label=paste0(params$ms_pct[4],"% Enrollment Milestone"), color="black", size=4) +
  ggtitle("BOLD Enrollment Progress") +
  ylab("Cumulative Randomizations") +
  xlab("Year") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.line = element_line(color='black'),
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.85, .1),
        legend.title = element_blank()) 

ggsave(file.path(data_dir,'dsmc_report','enrollment_projection.png'), enrollment_projection, scale = 1.1,width = 7, height = 4, units = "in")



###### Dataframe on enrollment ###### 

ph_screen <- bold %>%
  mutate(week = isoweek(scrn_date), year = year(scrn_date)) %>%
  arrange(year, week) %>%
  group_by(week, year) %>%
  count() %>%
  ungroup() %>%
  filter(!is.na(year)) %>%
  as_tibble(.) %>%
  arrange(year, week) %>%
  mutate(Screened = cumsum(n))

###### Graph of Phone Screens #####
screen_projection <- left_join(target, ph_screen) %>%
  select(week, year, Screened, `Screening Target`, Date) %>%
  filter(Date > "2021-09-27" & Date < "2025-03-31") %>%
  pivot_longer(., cols=-c(week,year, Date)) %>%
  arrange(name, Date) %>%
  rename(., Accrual = 'name',
         Counts = 'value') %>%
  filter(!is.na(Counts)) %>%
  as_tibble() %>%
  ggplot() +
  geom_line(aes(y=Counts, x=Date, group=Accrual, linetype=Accrual, col = Accrual), lwd = 1.5) +
  scale_linetype_manual(values=c("solid",'longdash')) +
  scale_color_manual(values=c("black","gray")) +
  scale_y_continuous(limits = c(0, 900), breaks=seq(0,900,100), expand = c(0, 0)) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[1], y=params$milestone_screen[1], yend=params$milestone_screen[1]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone_screen[1]+10, label=paste0(params$ms_pct[1],"% Screening Milestone"), color="black", size=3.75) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[2], y=params$milestone_screen[2], yend=params$milestone_screen[2]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone_screen[2]+10, label=paste0(params$ms_pct[2],"% Screening Milestone"), color="black", size=3.75) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[3], y=params$milestone_screen[3], yend=params$milestone_screen[3]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone_screen[3]+10, label=paste0(params$ms_pct[3],"% Screening Milestone"), color="black", size=3.75) +
  geom_segment(aes(x=as.POSIXct("2021-10-04"), xend=params$xend[4], y=params$milestone_screen[4], yend=params$milestone_screen[4]), linetype="solid", color = "gray", size=.5) +
  annotate("text", x=as.POSIXct("2022-02-06"), y=params$milestone_screen[4]+10, label=paste0(params$ms_pct[4],"% Screening Milestone"), color="black", size=3.75) +
  ggtitle("BOLD Phone Screening Progress") +
  ylab("Cumulative Phone Screening Performed") +
  xlab("Year") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.line = element_line(color='black'),
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.89, .1),
        legend.title = element_blank()) 

ggsave(file.path(data_dir,'dsmc_report','screen_projection.png'), screen_projection, scale = 1.1,width = 7, height = 4, units = "in")

### load graphs
knitr::include_graphics(file.path(data_dir,'dsmc_report','screen_projection.png'), dpi = 7) 
knitr::include_graphics(file.path(data_dir,'dsmc_report','enrollment_projection.png'), dpi = 7) 



```

\newpage

## Table 1: Participant Enrollment Status

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r table_1, echo=FALSE, warning=FALSE, message=FALSE}
#all of these numbers are calculated in dsmc_consort_generator_open.R
#Code was updated to pull from dsmc_consort_generator on 7/5/22

enrolled <- nrow(randomized)
preint <- nrow(randomized %>% filter(is.na(intervention_status)))
active <- nrow(randomized %>% filter(intervention_status == 1))
completed_num <- nrow(completed)
withdrawn_but_willing <- nrow(withdrawn_testing)
withdrawn_not_willing <- nrow(withdrawn_no_testing)
lost_to_followup <- nrow(lost)

table_1 <- data.frame(Status = c("Pre-Intervention", "Active", "Completed", "Discontinued Treatment/Follow-up Continued", "Discontinued from Study", "Lost to Follow-up"), 
                      N = c(preint, active, completed_num, withdrawn_but_willing, withdrawn_not_willing, lost_to_followup)) %>%
  mutate(Percent = scales::percent(N/enrolled, accuracy = 1))

table1 <- table_1 %>% 
  flextable() %>% 
  add_header_lines(., paste0("Participant Enrollment Status (N = ",enrolled,")")) %>%
  autofit() %>%
  theme_booktabs()

table1



```

### Reasons for Intervention Discontinuation

```{r withdraw_rsn, echo=FALSE, warning=FALSE, message=FALSE}
#all of these numbers are calculated in dsmc_consort_generator_open.R
#Code was updated to pull from dsmc_consort_generator on 7/5/22

withdraw_rsn_to_join <- look_up_table %>%
  filter(field == "withdraw_rsn") %>%
  select(-field)

reasons <- withdrawn_testing %>%
  bind_rows(., withdrawn_no_testing) %>%
  left_join(., withdraw_rsn_to_join, by = c('withdraw_rsn' = 'id_num')) %>%
  rename(Reason = 'id_name') %>%
  select(Reason)

if(nrow(reasons) > 0){
  gtsummary::tbl_summary(reasons) %>%
  modify_header(label = " ") %>%
  as_flex_table() %>%
  align(align = "center", part = "header") %>%
  set_table_properties(., layout = "autofit", width = 1)
} else {
  print("The have been no withdrawals yet.")
}



```

\newpage

## Table 2: Reasons for Screen Failures

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

### Phone-screen Screen Fails: By Race

```{r table_2a, echo=FALSE, warning=FALSE, message=FALSE}

#### Screen Fail Pre Consent #####
screen_fail_reason_pre_consent <- screen_fail_reason_temp %>%
  select(Reason, race)


gtsummary::tbl_summary(screen_fail_reason_pre_consent, by = race) %>%
  modify_header(label ~ " ") %>%
  add_overall() %>%
  as_flex_table() %>%
  fontsize(., size = 9, part = "all") %>%
  align(align = "center", part = "header") %>%
  add_header_lines("Phone-screen Screen Fails") %>%
  add_footer_lines("n - Number of listed screen-fail reason. \n\n(%) - Percent is calculated by dividing the number of a given reason (n) by the number of a racial or ethnic category (N). \n\nThis table is primarily used to examine racial differences for screen failing so that barriers to entry can be addressed.") %>%
  set_table_properties(., layout = "autofit", width = 1)

```

\newpage

### Phone-screen Screen Fails: Percentage of Total Screened

```{r table_2b, echo=FALSE, warning=FALSE, message=FALSE}

#### Screen Fail Pre Consent #####
screen_fail_reason_pre_consent <- screen_fail_reason_temp %>%
  select(Reason, race) 

gt_summary_table <- screen_fail_reason_pre_consent %>%
  gtsummary::tbl_summary(.,
                         by = race, 
                         statistic = list(all_categorical() ~ c("{n}"))) %>%
  add_overall()

#Isolate the table section of the gtsummary table and change statistics
#The gtsummary package is limited with available statistic calculation
#modify_table isolates the table from the gtsummary list and changes each statistic to be n (n/number consented)
modify_table <- gt_summary_table$table_body %>%
  mutate(across(contains("stat"), ~ case_when(!is.na(.x) ~ paste0(.x," (",as.character(round(as.numeric(.x)/nrow(screened)*100), digits = 0),"%)"))))

#Insert the modified table back into gtsummary list
gt_summary_table$table_body <- modify_table 


gt_summary_table %>%
  modify_header(label ~ " ") %>%
  modify_footnote(all_stat_cols() ~ "n (%)") %>%
  as_flex_table() %>%
  align(align = "center", part = "header") %>%
  add_header_lines(paste0("Phone-screen Screen Fails (Total Screened = ",nrow(screened),")")) %>%
  add_footer_lines(., "n - Number of listed screen-fail reason. \n\n(%) - Percent is calculated by dividing the number of a given reason (n) by the total number of phone screens (N).This percentage includes all eligible and still screening participants.") %>%
  fontsize(., size = 9, part = "all") %>%
  set_table_properties(., layout = "autofit", width = 1)



```

\newpage

### Post-consent Screen Fails: By Race and Ethnicity

```{r table_2c, echo=FALSE, warning=FALSE, message=FALSE}

#### Screen Fail Post Consent #####
screen_fail_after_consent_reason_dsmc <- screen_fail_after_consent_reason_temp %>%
  select(Reason, race)

gtsummary::tbl_summary(screen_fail_after_consent_reason_dsmc, by = race) %>%
  modify_header(label ~ " ") %>%
  add_overall() %>%
  as_flex_table() %>%
  fontsize(., size = 10, part = "all") %>%
  align(align = "center", part = "header") %>%
  add_header_lines("Post-consent Screen Fails") %>%
  add_footer_lines("n - Number of listed screen-fail reason. \n\n(%) - Percent is calculated by dividing the number of a given reason (n) by the number of a racial or ethnic category (N). \n\nThis table is primarily used to examine racial or ethnic differences for screen failing so that barriers to entry can be addressed.") %>%
  set_table_properties(., layout = "autofit", width = 1)

```

\newpage

### Post-consent Screen Fails: Percentage of Total Screened

```{r table_2d, echo=FALSE, warning=FALSE, message=FALSE}

#### Screen Fail Post Consent #####
screen_fail_after_consent_reason_dsmc <- screen_fail_after_consent_reason_temp %>%
  select(Reason, race)

table_2d <- screen_fail_after_consent_reason_dsmc %>%
  gtsummary::tbl_summary(.,
                         by = race, 
                         statistic = list(all_categorical() ~ c("{n}"))) %>%
  add_overall()

#Isolate the table section of the gtsummary table and change statistics
#The gtsummary package is limited with available statistic calculation
#modify_table isolates the table from the gtsummary list and changes each statistic to be n (n/number consented)
modify_table <- table_2d$table_body %>%
  mutate(across(contains("stat"), ~ case_when(!is.na(.x) ~ paste0(.x," (",as.character(round(as.numeric(.x)/nrow(consented)*100), digits = 0),"%)"))))

#Insert the modified table back into gtsummary list
table_2d$table_body <- modify_table 


table_2d %>%
  modify_header(label ~ " ") %>%
  modify_footnote(all_stat_cols() ~ "n (%)") %>%
  as_flex_table() %>%
  fontsize(., size = 10, part = "all") %>%
  align(align = "center", part = "header") %>%
  add_header_lines(., paste0("Post-consent Screen Fails (Total Consented = ",nrow(consented),")")) %>%
  add_footer_lines(., "n - Number of listed screen-fail reason. \n\n(%) - Percent is calculated by dividing the number of a given reason (n) by the total number of consents. This percentage includes all eligible and still screening participants.") %>%
  set_table_properties(., layout = "autofit", width = 1)


```

\newpage

## Table 3a: Demographic and Key Baseline Characteristics

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r table_4, echo=FALSE, warning=FALSE, message=FALSE, include = FALSE}
#20230627: This was the old reporting method. Updated today. JC
#Source  https://www.ers.usda.gov/data-products/rural-urban-commuting-area-codes/
#Updated on 8/18/22 with list from EDV
rural_zips <- import(file.path(data_dir,'dsmc_report','forhp-eligible-zips.xlsx')) %>%
  pull(ZIP_CODE)

enrolled_df <- randomized 

test <- enrolled_df  %>%
  mutate(Rural = case_when(scrn_address_zip %in% rural_zips ~ "Rural",
                           T ~ "Not Rural")) %>%
  select(race, ethnicity, sex, Rural, age) %>%
  rename(Race = race, Ethnicity = ethnicity, Sex = sex, Age = age)

table_3a <- gtsummary::tbl_summary(test,
                                   statistic = all_continuous() ~ "{mean}, ({sd})",
                                   type = list(Age ~ "continuous")) %>%
  modify_header(label ~ " ") %>%
  as_flex_table() %>%
  autofit()

table_3a 






```

```{r table_4_2, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=8}
#' 20230627: This section was rewritten to accomodate DSMC feedback. JC


#Source  https://www.ers.usda.gov/data-products/rural-urban-commuting-area-codes/
#Updated on 8/18/22 with list from EDV
rural_zips <- import(file.path(data_dir,'dsmc_report','forhp-eligible-zips.xlsx')) %>%
  pull(ZIP_CODE)

#### Since Last Report ####
dems_since_last_report <- randomized %>%
  mutate(Rural = case_when(scrn_address_zip %in% rural_zips ~ "Rural",
                           T ~ "Not Rural")) %>%
  mutate(updates = case_when(rand_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(race, ethnicity, sex, Rural, age, updates) %>%
  rename(Race = race, Ethnicity = ethnicity, Sex = sex, Age = age)


table_3a <- gtsummary::tbl_summary(dems_since_last_report,
                                   by = updates,
                                   statistic = all_continuous() ~ "{mean}, ({sd})",
                                   type = list(Age ~ "continuous")) %>%
  add_overall() %>%
  modify_header(label ~ " ") %>%
  as_flex_table() %>%
  add_header_lines("Enrollment Demographics Since Last Report") %>%
  set_table_properties(., layout = "autofit", width = 1)

table_3a 

add_table(table_3a)




```

\newpage

```{r table_4_3, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=8}
#' 20230627: This section was rewritten to accomodate DSMC feedback. JC


#Source  https://www.ers.usda.gov/data-products/rural-urban-commuting-area-codes/
#Updated on 8/18/22 with list from EDV
rural_zips <- import(file.path(data_dir,'dsmc_report','forhp-eligible-zips.xlsx')) %>%
  pull(ZIP_CODE)



dems_every_6mo <- randomized %>%
  mutate(Rural = case_when(scrn_address_zip %in% rural_zips ~ "Rural",
                           T ~ "Not Rural"))  %>%
  mutate(month = month(rand_date),
         year = year(rand_date)) %>%
  mutate(biyear = case_when(month %in% semester_1 ~ mdy(paste0(semester_1_string,year)),
                            month %in% semester_2 ~ mdy(paste0(semester_2_string,year)))) %>%
  select(race, ethnicity, sex, Rural, age, biyear) %>%
  rename(Race = race, Ethnicity = ethnicity, Sex = sex, Age = age)

table_3a_2 <- gtsummary::tbl_summary(dems_every_6mo,
                                     by = biyear,
                                     statistic = all_continuous() ~ "{mean}, ({sd})",
                                     type = list(Age ~ "continuous")) %>%
  modify_header(label ~ " ") %>%
  as_flex_table() %>%
  add_header_lines("Enrollment Demographics - Group by Reporting Period") %>%
  set_table_properties(., layout = "autofit", width = 1)

table_3a_2

add_table(table_3a_2)




```

\newpage

## Table 3b: Demographic and Key Baseline Characteristics

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r screened_dems, echo=FALSE, warning=FALSE, message=FALSE}

#Source  https://www.ers.usda.gov/data-products/rural-urban-commuting-area-codes/
#Updated with list from EDV on 8/18/22
rural_zips <- import(file.path(data_dir,'dsmc_report','forhp-eligible-zips.xlsx')) %>%
  pull(ZIP_CODE)

screened_df <- screened

test <- screened_df  %>%
  mutate(Rural = case_when(scrn_address_zip %in% rural_zips ~ "Rural",
                           T ~ "Not Rural")) %>%
  mutate(updates = case_when(scrn_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(race, ethnicity, sex, Rural, age, updates) %>%
  rename(Race = race, Ethnicity = ethnicity, Sex = sex, Age = age)



table_3b <- gtsummary::tbl_summary(test,
                                   by = updates,
                                   statistic = all_continuous() ~ "{mean}, ({sd})",
                                   type = list(Age ~ "continuous")) %>%
  add_overall() %>%
  modify_header(label ~ " ") %>%
  as_flex_table() %>%
  add_header_lines("Screened Demographics Since Last Report") %>%
  set_table_properties(., layout = "autofit", width = 1)


table_3b

add_table(table_3b)


```

\newpage

```{r screened_dems_6mo, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=8}
#' 20230818: This section was rewritten to accomodate DSMC feedback. JC


#Source  https://www.ers.usda.gov/data-products/rural-urban-commuting-area-codes/
#Updated on 8/18/22 with list from EDV
rural_zips <- import(file.path(data_dir,'dsmc_report','forhp-eligible-zips.xlsx')) %>%
  pull(ZIP_CODE)

dems_every_6mo <- screened %>%
  mutate(Rural = case_when(scrn_address_zip %in% rural_zips ~ "Rural",
                           T ~ "Not Rural"))  %>%
  mutate(month = month(scrn_date),
         year = year(scrn_date)) %>%
  mutate(biyear = case_when(month %in% semester_1 ~ mdy(paste0(semester_1_string,year)),
                            month %in% semester_2 ~ mdy(paste0(semester_2_string,year)))) %>%
  select(race, ethnicity, sex, Rural, age, biyear) %>%
  rename(Race = race, Ethnicity = ethnicity, Sex = sex, Age = age)

table_3b_2 <- gtsummary::tbl_summary(dems_every_6mo,
                                     by = biyear,
                                     statistic = all_continuous() ~ "{mean}, ({sd})",
                                     type = list(Age ~ "continuous")) %>%
  modify_header(label ~ " ") %>%
  as_flex_table() %>%
  add_header_lines("Screened Demographics - Group by Reporting Period") %>%
  set_table_properties(., layout = "autofit", width = 1)

table_3b_2

add_table(table_3b_2)


```

\newpage

# Protocol Fidelity

**Protocol Deviation**

A protocol deviation occurs when, without significant consequences, the activities on a study diverge from the Institutional Review Board-approved protocol.

-   Study visit occurred outside of protocol time frame due to participant's schedule

-   Study activities performed close to, but not precisely at specified time points

**Protocol Violation**

A divergence from the protocol that materially (a) reduces the quality or completeness of the data, (b) makes the Informed Consent Form inaccurate, or (c) impacts a subject's safety, rights, or welfare.

-   Failure to obtain informed consent or re-consent when required by the IRB.

-   Modifying the protocol without IRB approval, except to avoid immediate hazard to subjects.

-   Inadequate or delinquent informed consent

-   Inclusion/exclusion criteria not met

-   Unreported serious adverse events

-   Improper breaking of the blind

-   Use of prohibited medication

-   Mishandled samples

-   Materially inadequate record keeping

-   Intentional deviation from protocol, Good Clinical Practice, or regulations by study personnel

**Reference**

See Bhatt (2012) for more information.

Bhatt A. Protocol deviation and violation. Perspect Clin Res. 2012 Jul;3(3):117. doi: 10.4103/2229-3485.100663. PMID: 23125964; PMCID: PMC3487227.

\newpage

## Table 4: Protocol Violations

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r table_3a, echo=FALSE, warning=FALSE, message=FALSE}
violations_to_join <- look_up_table %>%
  filter(field == "deviation_type") %>%
  select(-field) %>%
  rename(`Protocol Violation` = 'id_name')

violations <- bold %>%
  filter(ae_dev_or_vio == 2) %>%
  left_join(., violations_to_join, by = c('deviation_type' = 'id_num'))

protocol_violations <- violations %>%
  group_by(`Protocol Violation`) %>%
  count() 


violations_after_last_report <- violations %>%
  filter(deviation_date > date_of_last_report) %>%
  group_by(`Protocol Violation`) %>%
  count() %>%
  rename(`Since Last DSMC Report` = n)

total_violations <- sum(protocol_violations$n)
total_violations_after_last_report <- sum(violations_after_last_report$`Since Last DSMC Report`)

consented_since_last_report <- bold %>%
  filter(consent_date > date_of_last_report) %>%
  nrow(.)

table_3a <- protocol_violations %>%
  left_join(., violations_after_last_report) %>%
  ungroup() %>%
  add_row(`Protocol Violation` = "Total # of Violations", n = total_violations, `Since Last DSMC Report` = total_violations_after_last_report) %>%
  add_row(`Protocol Violation` = "Participants Consented", n = nrow(consented), `Since Last DSMC Report` = consented_since_last_report) %>%
  add_row(`Protocol Violation` = "Violations per Participant", n = round(total_violations / nrow(consented), digits = 2), `Since Last DSMC Report` = round(total_violations_after_last_report / consented_since_last_report, digits = 2))


table_3a_2 <- table_3a %>%
  flextable() %>%
  theme_booktabs() %>%
  #hline(i = nrow(table_3a)-3) %>%
  autofit() 

table_3a_2 

add_table(table_3a_2)


```

\newpage

## Table 5: Protocol Deviations

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r table_3b, echo=FALSE, warning=FALSE, message=FALSE}
deviations_to_join <- look_up_table %>%
  filter(field == "deviation_type") %>%
  select(-field) %>%
  rename(`Protocol Deviation` = 'id_name')

deviations <- bold %>%
  filter(ae_dev_or_vio == 1) %>%
  left_join(., deviations_to_join, by = c('deviation_type' = 'id_num'))


protocol_deviations <- deviations %>%
  group_by(`Protocol Deviation`) %>%
  count() 


deviations_after_last_report <- deviations %>%
  filter(deviation_date > date_of_last_report) %>%
  group_by(`Protocol Deviation`) %>%
  count() %>%
  rename(`Since Last DSMC Report` = n)

total_deviations <- sum(protocol_deviations$n)
total_deviations_after_last_report <- sum(deviations_after_last_report$`Since Last DSMC Report`)

consented_since_last_report <- bold %>%
  filter(consent_date > date_of_last_report) %>%
  nrow(.)

table_3b <- protocol_deviations %>%
  left_join(., deviations_after_last_report) %>%
  ungroup() %>%
  add_row(`Protocol Deviation` = "Total # of Deviations", n = total_deviations, `Since Last DSMC Report` = total_deviations_after_last_report) %>%
  add_row(`Protocol Deviation` = "Participants Consented", n = nrow(consented), `Since Last DSMC Report` = consented_since_last_report) %>%
  add_row(`Protocol Deviation` = "Deviations per Participant", n = round(total_deviations / nrow(consented), digits = 2), `Since Last DSMC Report` = round(total_deviations_after_last_report / consented_since_last_report, digits = 2))


table_3b %>%
  flextable() %>%
  theme_booktabs() %>%
  #hline(i = nrow(table_3b)-3) %>%
  autofit() 



```

\newpage

## Listing 1: New Protocol Violations

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

```{r listing_1_protocol_violation, echo=FALSE, warning=FALSE, message=FALSE}

listing_1_pv <- violations %>%
  filter(ae_dev_or_vio == 2) %>%
  filter(deviation_date_indentified >= date_of_last_report) %>%

  mutate(`Resulted in AE` = case_when(deviation_ae == 1 ~ "Yes",
                                      deviation_ae == 0 ~ "No")) %>%
  mutate(`Participant Continued` = case_when(deviation_pt_continue == 1 ~ "Yes",
                                             deviation_pt_continue == 0 ~ "No")) %>%
  select(deviation_date, `Protocol Violation`, `Resulted in AE`, `Participant Continued`, deviation_description) %>%
  rename("Date" = deviation_date, "Notes" = deviation_description) %>%
  arrange(Date)

if(nrow(listing_1_pv) > 0) {
  listing_1_pv %>% 
    flextable() %>% 
    align(align = "center", part = "header") %>%
    add_header_lines(., paste0("Protocol Deviations Since Date of Last Report (",date_of_last_report,")")) %>% 
    theme_booktabs() %>%
    set_table_properties(., layout = "autofit", width = 1)
} else {
  cat("There have been no new violations.")
}



```

\newpage

## Listing 2: All Protocol Violations

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

```{r all_protocol_violations, echo=FALSE, warning=FALSE, message=FALSE}



all_violations <- violations %>%
  mutate(`Resulted in AE` = case_when(deviation_ae == 1 ~ "Yes",
                                      deviation_ae == 0 ~ "No")) %>%
  mutate(`Participant Continued` = case_when(deviation_pt_continue == 1 ~ "Yes",
                                             deviation_pt_continue == 0 ~ "No")) %>%
  select(deviation_date, `Protocol Violation`, `Resulted in AE`, `Participant Continued`, deviation_description) %>%
  rename("Date" = deviation_date, "Notes" = deviation_description) %>%
  arrange(Date)

if(nrow(all_violations) > 0) {
  all_violations %>% 
    flextable() %>% 
    align(align = "center", part = "header") %>%
    add_header_lines(., paste0("All Protocol Deviations")) %>% 
    theme_booktabs() %>%
    set_table_properties(., layout = "autofit", width = 1)
} else {
  cat("There have been no violations.")
}



```

\newpage

## Table 6: Data Counts

This section will not work. Would need to be rewritten specifically for BOLD project. 

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

```{r data_counts, echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}


expected_baseline <- randomized %>%
  mutate(record_id = as.character(record_id))

expected_week_26 <- comet %>%
  mutate(final_date = case_when(intervention_status == 1 ~ today(),
                                intervention_status == 2 ~ today(),
                                intervention_status == 3 ~ today(),
                                intervention_status == 4 ~ int_withdrew_date,
                                intervention_status == 5 ~ int_losttofollowup_date)) %>%
  filter(final_date >= comet_week26date + days(12))

expected_week_52 <- comet %>%
  mutate(final_date = case_when(intervention_status == 1 ~ today(),
                                intervention_status == 2 ~ today(),
                                intervention_status == 3 ~ today(),
                                intervention_status == 4 ~ int_withdrew_date,
                                intervention_status == 5 ~ int_losttofollowup_date)) %>%
  filter(final_date >= comet_week52date + days(12))

baseline_tests <- randomized %>%
  select(record_id, redcap_event_name, cog_date, mri_date, ex_dxa_date, ex_1rm_staff, ex_gxt_staff, barse_1, ex_blood_1_time) %>%
  mutate(across(.cols = c("cog_date", "mri_date", "ex_dxa_date", "ex_1rm_staff", "ex_gxt_staff", "barse_1", "ex_blood_1_time"),
                .fns = ~ ifelse(!is.na(.x) == TRUE, 1, 0))) %>%
  mutate(record_id = as.character(record_id)) 


week_26_tests <- comet %>%
  filter(redcap_event_name == "week_26_arm_1") %>%
  filter(record_id %in% expected_week_26$record_id) %>%
  select(record_id, redcap_event_name, cog_date, barse_1) %>%
  mutate(across(.cols = c("cog_date", "barse_1"),
                .fns = ~ ifelse(!is.na(.x) == TRUE, 1, 0))) 


week_52_tests <- comet %>%
  filter(redcap_event_name == "week_52_arm_1") %>%
  filter(record_id %in% expected_week_52$record_id) %>%
  select(record_id, redcap_event_name, cog_date, mri_date, ex_dxa_date, ex_1rm_staff, ex_gxt_staff, barse_1, ex_blood_1_time) %>%
  mutate(across(.cols = c("cog_date", "mri_date", "ex_dxa_date", "ex_1rm_staff", "ex_gxt_staff", "barse_1", "ex_blood_1_time"),
                .fns = ~ ifelse(!is.na(.x) == TRUE, 1, 0))) %>%
  mutate(record_id = as.character(record_id)) 

baseline_name <- paste0("Baseline (N=",nrow(expected_baseline),")")
week_26_name <- paste0("Week 26 (N=",nrow(expected_week_26),")")
week_52_name <- paste0("Week 56 (N=",nrow(expected_week_52),")")

data_counts <- data.frame(Measure = c("Cognitive Testing – 1º", "MRI – 2º", "GXT – 2º", "1-RM – 2º", "DXA – 2º", "Home Survey Battery – 2º", "Phlebotomy – eº"),
                          Baseline = c(sum(baseline_tests$cog_date), sum(baseline_tests$mri_date), sum(baseline_tests$ex_gxt_staff), sum(baseline_tests$ex_1rm_staff), sum(baseline_tests$ex_dxa_date), sum(baseline_tests$barse_1), sum(baseline_tests$ex_blood_1_time)),
                          week_26 = c(sum(week_26_tests$cog_date), NA, NA, NA, NA, sum(week_26_tests$barse_1), NA),
                          week_52 = c(sum(week_52_tests$cog_date), sum(week_52_tests$mri_date), sum(week_52_tests$ex_gxt_staff), sum(week_52_tests$ex_1rm_staff), sum(week_52_tests$ex_dxa_date), sum(week_52_tests$barse_1), sum(week_52_tests$ex_blood_1_time))) %>%
  rename(!!baseline_name := Baseline, !!week_26_name := week_26, !!week_52_name := week_52)



table_6 <- data_counts %>% 
  flextable() %>% 
  add_header_lines(., "Data Counts – Primary and Secondary Measures") %>% 
  add_footer_lines(., "1º primary outcome, 2º secondary outcome, eº exploratory measure") %>%
  add_footer_lines(paste0("Data counts reflect the database as of ",data_date,". Some missing data are expected as tests are ongoing and data continue to be entered.")) %>%
  align(align = "center", part = "header") %>%
  theme_booktabs() %>%
  set_table_properties(., layout = "autofit", width = 1)

table_6

add_table(table_6)



```

\newpage

# Safety Assessments for All Participants: Tables and Listing

## CTCAE 5.0 Criteria

**Grades**

Grade refers to the severity of the AE. The CTCAE displays Grades 1 through 5 with unique clinical descriptions of severity for each AE based on this general guideline:

-   **Grade 1** Mild; asymptomatic or mild symptoms; clinical or diagnostic observations only; intervention not indicated.

-   **Grade 2** Moderate; minimal, local or noninvasive intervention indicated; limiting age-appropriate instrumental ADL\*.

-   **Grade 3** Severe or medically significant but not immediately life-threatening; hospitalization or prolongation of hospitalization indicated; disabling; limiting self care ADL\*\*.

-   **Grade 4** Life-threatening consequences; urgent intervention indicated.

-   **Grade 5** Death related to AE.

**Relatedness**

Relatedness refers to the relationship of the AE to the intervention. COMET rates relatedness from not related to definitely related.

-   **Not Related** The AE is clearly NOT related to the intervention

-   **Possibly Related** The AE may be related to the intervention

-   **Definitely Related** The AE is clearly related to the intervention

**Definitions**

-   **Adverse Event** Any untoward or unfavorable medical occurrence in a human subject participant, including any abnormal sign, symptom, or disease, temporally associated with the participants' involvement in the research, whether or not considered related to participation in the research.

-   **Event of Interest** Incidental findings or events uncovered during baseline testing not directly attributable to the study. It is often unclear if the event is new onset. Most are pre-existing and asymptomatic i.e., asymptomatic ST segment depression on a maximal exercise test.

-   **System Organ Class (SOC)** The highest level of the MedDRA1 hierarchy, also referred to as System Organ Classe (SOC), is identified by anatomical or physiological system, etiology, or purpose (e.g., SOC Investigations for laboratory test results). CTCAE terms are grouped by MedDRA Primary SOCs. Within each SOC, AEs are listed and accompanied by descriptions of severity (Grade).

-   **Preferred Term** A term that is a unique representation of a specific event used for medical documentation and scientific analyses. Each CTCAE v4.0 term is a MedDRA LLT (Lowest Level Term).

\newpage

## Table 7a: Non-related Adverse Events

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r table_6_events_conditional, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8}


adverse_events_6 <- ae_master %>%
  filter(ae_related == 0) %>% 
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

criteria <- nrow(adverse_events_6) > 0
```

```{r table_6_false, echo=FALSE, warning=FALSE, message=FALSE, eval = !criteria}

print("There have been no non-related adverse events.")

```


```{r table_6_events_summary, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, eval=criteria}

  table_7a <- gtsummary::tbl_summary(adverse_events_6,
                                   by = updates,
                                   sort = everything() ~ "frequency") %>%
  add_overall() %>%
  modify_header(label ~ "Adverse Events") %>%
  as_flex_table() %>%
  align(align = "center", part = "header") %>%
  add_header_lines(., "Non-related Adverse Events Since Last Report") %>%
  set_table_properties(., layout = "autofit", width = 1)

table_7a

add_table(table_7a)

```

\newpage

```{r table_6_events_6mo, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, eval=criteria}
#' 20230822: Adding in response to DSMC notes. JC

adverse_events_6 <- ae_master %>%
  filter(ae_related == 0) %>% 
  mutate(month = month(ae_date),
         year = year(ae_date)) %>%
  mutate(updates = case_when(month %in% semester_2 ~ mdy(paste0("0831",year)),
                             month %in% semester_1 ~ mdy(paste0("0228",year+1)),
                             month == 1 | month == 2 ~ mdy(paste0("0228",year)))) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

  table_7a_2 <- gtsummary::tbl_summary(adverse_events_6,
                                       by = updates,
                                       sort = everything() ~ "frequency") %>%
    modify_header(label ~ "Adverse Events") %>%
    as_flex_table() %>%
    align(align = "center", part = "header") %>%
    add_header_lines(., "Non-related Adverse Events - Group by Reporting Period") %>%
    add_footer_lines(., "If a reporting period is not included, no related adverse events happened during that period.") %>%
    set_table_properties(., layout = "autofit", width = 1)
  
  table_7a_2
  
  add_table(table_7a_2)




```

\newpage

```{r table_6_listing, echo=FALSE, warning=FALSE, message=FALSE, eval = criteria}


adverse_event_6_listing <- ae_master %>%
  filter(ae_related == 0) %>% 
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  filter(ae_date >= date_of_last_report) %>%
  #For Investigators to see AEs
  #select(record_id, redcap_repeat_instance, ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  select(ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  arrange(ctcae_term) %>%
  rename( "Summary" = ae_dsmc_summary, "Date of Onset" = ae_date_of_onset, 
          "Preferred Term" = ctcae_term) 

  adverse_event_6_listing %>% 
    flextable() %>% 
    # add_header_lines(., paste0("Total N = ",completed_baseline)) %>% 
    # add_header_lines(., "Treatment Duration for All Participants") %>% 
    theme_booktabs() %>%
    set_table_properties(., layout = "autofit", width = 1) %>%
    add_header_lines("Non-related Adverse Events Since Last Report")

```

\newpage

## Table 7b: Related Adverse Events

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline
```{r table_6b_events_cond, echo=FALSE, warning=FALSE, message=FALSE}


adverse_events_6 <- ae_master %>%
  filter(ae_related != 0) %>%
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

criteria <- nrow(adverse_events_6) > 0



```

```{r table_6b_events_false, echo=FALSE, warning=FALSE, message=FALSE, eval=!criteria}


print("There have been no related adverse events")

```


```{r table_6b_events_summary, echo=FALSE, warning=FALSE, message=FALSE, eval=criteria, fig.show='asis'}


adverse_events_6 <- ae_master %>%
  filter(ae_related != 0) %>%
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

  table_7b <- gtsummary::tbl_summary(adverse_events_6,
                                     by = updates,
                                     sort = everything() ~ "frequency") %>%
    add_overall() %>%
    modify_header(label ~ "Adverse Events") %>%
    as_flex_table() %>%
    align(align = "center", part = "header") %>%
    add_header_lines(., "Related Adverse Events Since Last Report") %>%
    add_footer_lines(., "*Table includes both possibly- and definitely-related adverse events.") %>%
    set_table_properties(., layout = "autofit", width = 1)
  
  table_7b
  
  add_table(table_7b)



```

\newpage

```{r table_6b_events_6mo, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, eval=criteria}
#' 20230822: Adding in response to DSMC notes. JC

adverse_events_6 <- ae_master %>%
  filter(ae_related != 0) %>% 
  mutate(month = month(ae_date),
         year = year(ae_date)) %>%
  mutate(updates = case_when(month %in% semester_2 ~ mdy(paste0("0831",year)),
                             month %in% semester_1 ~ mdy(paste0("0228",year+1)),
                             month == 1 | month == 2 ~ mdy(paste0("0228",year)))) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)


table_7b_2 <- gtsummary::tbl_summary(adverse_events_6,
                                     by = updates,
                                     sort = everything() ~ "frequency") %>%
  modify_header(label ~ "Adverse Events") %>%
  as_flex_table() %>%
  align(align = "center", part = "header") %>%
  add_header_lines(., "Related Adverse Events - Group by Reporting Period") %>%
  add_footer_lines(., "If a reporting period is not included, no related adverse events happened during that period.") %>%
  set_table_properties(., layout = "autofit", width = 1)

table_7b_2

add_table(table_7b_2)

```

\newpage

```{r table_6b_listing, echo=FALSE, warning=FALSE, message=FALSE, include = TRUE, eval=criteria}


adverse_event_6_listing <- ae_master %>%
  filter(ae_related != 0) %>% 
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  filter(ae_date >= date_of_last_report) %>%
  #For investigators
  #select(record_id, redcap_repeat_instance, ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  select(ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  arrange(ctcae_term) %>%
  rename( "Summary" = ae_dsmc_summary, "Date of Onset" = ae_date_of_onset, 
          "Preferred Term" = ctcae_term) 

  adverse_event_6_listing %>% 
    flextable() %>% 
    # add_header_lines(., paste0("Total N = ",completed_baseline)) %>% 
    # add_header_lines(., "Treatment Duration for All Participants") %>% 
    theme_booktabs() %>%
    set_table_properties(., layout = "autofit", width = 1) %>%
    add_header_lines("Related Adverse Events Since Last Report")




```

\newpage

## Table 7c: Non-related Serious Adverse Events

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline
```{r table_7c_cond, echo=FALSE, warning=FALSE, message=FALSE}


adverse_events_6 <- ae_master %>%
  filter(ae_related == 0 &
           ae_was_ae_serious == 1) %>% 
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

crit <- nrow(adverse_events_6) > 0



```

```{r table_7c_false, echo=FALSE, warning=FALSE, message=FALSE, eval=!crit}

print("There have been no non-related serious adverse events")

```


```{r table_7c, echo=FALSE, warning=FALSE, message=FALSE, eval=crit}


adverse_events_6 <- ae_master %>%
  filter(ae_related == 0 &
           ae_was_ae_serious == 1) %>% 
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

  table_7c <- gtsummary::tbl_summary(adverse_events_6,
                                     by = updates,
                                     sort = everything() ~ "frequency") %>%
    add_overall() %>%
    modify_header(label ~ "Adverse Events") %>%
    as_flex_table() %>%
    align(align = "center", part = "header") %>%
    add_header_lines(., "Non-related Serious Adverse Events Since Last Report") %>%
    set_table_properties(., layout = "autofit", width = 1)
  
  table_7c
  
  add_table(table_7c)





```

\newpage

```{r table_7c_events_6mo, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, eval=crit}
#' 20230822: Adding in response to DSMC notes. JC


adverse_events_6 <- ae_master %>%
  filter(ae_related == 0 &
           ae_was_ae_serious == 1) %>% 
  mutate(month = month(ae_date),
         year = year(ae_date)) %>%
  mutate(updates = case_when(month %in% semester_2 ~ mdy(paste0("0831",year)),
                             month %in% semester_1 ~ mdy(paste0("0228",year+1)),
                             month == 1 | month == 2 ~ mdy(paste0("0228",year)))) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)


  table_7c_2 <- gtsummary::tbl_summary(adverse_events_6,
                                       by = updates,
                                       sort = everything() ~ "frequency") %>%
    modify_header(label ~ "Adverse Events") %>%
    as_flex_table() %>%
    align(align = "center", part = "header") %>%
    add_header_lines(., "Non-related Serious Adverse Events - Group by Reporting Period") %>%
    add_footer_lines(., "If a reporting period is not included, no related adverse events happened during that period.") %>%
    set_table_properties(., layout = "autofit", width = 1)
  
  table_7c_2
  
  add_table(table_7c_2)



```

\newpage

```{r table_7c_listing, echo=FALSE, warning=FALSE, message=FALSE, include = TRUE, eval=crit}


adverse_event_6_listing <- ae_master %>%
  filter(ae_related == 0 &
           ae_was_ae_serious == 1) %>%  
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  filter(ae_date >= date_of_last_report) %>%
  #For investigators
  #select(record_id, redcap_repeat_instance, ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  select(ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  arrange(ctcae_term) %>%
  rename( "Summary" = ae_dsmc_summary, "Date of Onset" = ae_date_of_onset, 
          "Preferred Term" = ctcae_term) 

  adverse_event_6_listing %>% 
    flextable() %>% 
    # add_header_lines(., paste0("Total N = ",completed_baseline)) %>% 
    # add_header_lines(., "Treatment Duration for All Participants") %>% 
    theme_booktabs() %>%
    set_table_properties(., layout = "autofit", width = 1) %>%
    add_header_lines("Non-related Serious Adverse Events Since Last Report")


```

\newpage

## Table 7d: Related Serious Adverse Events

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r table_7d_cond, echo=FALSE, warning=FALSE, message=FALSE}


adverse_events_6 <- ae_master %>%
  filter(ae_related > 0 & ae_was_ae_serious == 1) %>% 
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

crit <- nrow(adverse_events_6) > 0


```

```{r table_7d_false, echo=FALSE, warning=FALSE, message=FALSE, eval=!crit}

print("There have been no related serious adverse events.")

```


```{r table_7d, echo=FALSE, warning=FALSE, message=FALSE, eval=crit}


adverse_events_6 <- ae_master %>%
  filter(ae_related > 0 & ae_was_ae_serious == 1) %>% 
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

  table_7d <- gtsummary::tbl_summary(adverse_events_6,
                                   by = updates,
                                   sort = everything() ~ "frequency") %>%
  add_overall() %>%
  modify_header(label ~ "Adverse Events") %>%
  as_flex_table() %>%
  align(align = "center", part = "header") %>%
  add_header_lines(., "Related Serious Adverse Events Since Last Report") %>%
  add_footer_lines(., "*Table includes both possibly- and definitely-related adverse events.") %>%
  set_table_properties(., layout = "autofit", width = 1)

table_7d

add_table(table_7d)


```

\newpage

```{r table_7d_events_6mo, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, eval=crit}
#' 20230822: Adding in response to DSMC notes. JC

adverse_events_6 <- ae_master %>%
  filter(ae_related > 0 &
           ae_was_ae_serious == 1) %>% 
  mutate(month = month(ae_date),
         year = year(ae_date)) %>%
  mutate(updates = case_when(month %in% semester_2 ~ mdy(paste0("0831",year)),
                             month %in% semester_1 ~ mdy(paste0("0228",year+1)),
                             month == 1 | month == 2 ~ mdy(paste0("0228",year)))) %>%
  select(ctcae_term, updates) %>%
  rename("Preferred Term" = ctcae_term)

  table_7d_2 <- gtsummary::tbl_summary(adverse_events_6,
                                       by = updates,
                                       sort = everything() ~ "frequency") %>%
    modify_header(label ~ "Adverse Events") %>%
    as_flex_table() %>%
    align(align = "center", part = "header") %>%
    add_header_lines(., "Related Serious Adverse Events - Group by Reporting Period") %>%
    add_footer_lines(., "If a reporting period is not included, no related adverse events happened during that period.") %>%
    set_table_properties(., layout = "autofit", width = 1)
  
  table_7d_2
  
  add_table(table_7d_2)



```

\newpage

```{r table_7d_listing, echo=FALSE, warning=FALSE, message=FALSE, include = TRUE, eval=crit}


adverse_event_6_listing <- ae_master %>%
  filter(ae_related > 0 &
           ae_was_ae_serious == 1) %>%  
  mutate(updates = case_when(ae_date < date_of_last_report ~ "Cumulative at Last Report",
                             T ~ "Since Last Report")) %>%
  filter(ae_date >= date_of_last_report) %>%
  #For investigators
  #select(record_id, redcap_repeat_instance, ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  select(ae_date_of_onset, Outcome, ctcae_term, ae_dsmc_summary) %>%
  arrange(ctcae_term) %>%
  rename( "Summary" = ae_dsmc_summary, "Date of Onset" = ae_date_of_onset, 
          "Preferred Term" = ctcae_term) 

  adverse_event_6_listing %>% 
    flextable() %>% 
    # add_header_lines(., paste0("Total N = ",completed_baseline)) %>% 
    # add_header_lines(., "Treatment Duration for All Participants") %>% 
    theme_booktabs() %>%
    set_table_properties(., layout = "autofit", width = 1) %>%
    add_header_lines("Related Serious Adverse Events Since Last Report")




```

\newpage

## Listing 3: Serious Adverse Events

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r listing_1a, echo=FALSE, warning=FALSE, message=FALSE}

# To do: need to update names and add in outcome column

listing_1 <- ae_master %>%
  filter(ae_was_ae_serious == 1) %>%
  select(ae_date_of_onset, ae_date_ceased, Related, Outcome, `SOC and Preferred Term`, ae_dsmc_summary) %>%
  rename("Summary" = ae_dsmc_summary, "Date of Onset" = ae_date_of_onset, "Date Ceased" = ae_date_ceased)

if(nrow(listing_1) > 0) {
  listing_1 %>% 
    flextable() %>% 
    # add_header_lines(., paste0("Total N = ",completed_baseline)) %>% 
    # add_header_lines(., "Treatment Duration for All Participants") %>% 
    theme_booktabs() %>%
    set_table_properties(., layout = "autofit", width = 1)
} else {
  cat("There have been no serious adverse events")
}


```

\newpage

## Listing 4: Deaths

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r listing_2, echo=FALSE, warning=FALSE, message=FALSE}

# To do: need to update names and add in outcome column

listing_2 <- ae_master %>%
  filter(!is.na(ae_death_date)) %>%
  rename("Date of Death" = ae_death_date, "Cause of Death" = ae_death_cause) %>%
  select("Date of Death", "Cause of Death", Related) 


if(nrow(listing_2) > 0) {
  listing_2 %>% 
    flextable() %>% 
    autofit() %>%
    theme_booktabs()
} else {
  cat("There have been no deaths.")
}


```

\newpage

## Listing 5a: New Adverse Events Related to the Intervention

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r listing_3a, echo=FALSE, warning=FALSE, message=FALSE}
####This is actually listing_4a. A protocol deviation listing was added above, and all code below was kept consistent to save time.

listing_3a <- ae_master %>%
  filter(ae_date >= date_of_last_report) %>%
  filter(ae_related != 0) %>%
  arrange(desc(.$ae_related), ae_date) %>%
  select(ae_date, Related, Outcome, Severity, `SOC and Preferred Term`, ae_dsmc_summary) %>%
  rename("Date" = ae_date, "Summary" = ae_dsmc_summary) 


listing_3a %>% 
  flextable() %>% 
  align(align = "center", part = "header") %>%
  add_header_lines(., paste0("Adverse Events Related to the Intervention Since Date of Last Report (",date_of_last_report,")")) %>% 
  theme_booktabs() %>%
  set_table_properties(., layout = "autofit", width = 1)


```

\newpage

```{r listing_3a_powerpoint, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, include=FALSE}
#' 20230802 This was added to for the presentation of AEs only. It's not included in the report, but is used to generate a table of AEs that are 
#' easy to show during the powerpoint
#' 20230823: Removed from presentation. Do

listing_3a <- ae_master %>%
  filter(ae_date >= date_of_last_report) %>%
  filter(ae_related != 0) %>%
  arrange(desc(.$ae_related), ae_date) %>%
  select(ae_date, Related, Outcome, Severity, ctcae_term) %>%
  rename("Date" = ae_date, "Event" = ctcae_term) 


listing_3a %>% 
  flextable() %>% 
  align(align = "center", part = "header") %>%
  add_header_lines(., paste0("Adverse Events Related to the Intervention Since Date of Last Report (",date_of_last_report,")")) %>% 
  theme_booktabs() %>%
  set_table_properties(., layout = "autofit")



```

\newpage

## Listing 5b: New Adverse Events Not Related to Intervention

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r listing_3b, echo=FALSE, warning=FALSE, message=FALSE}

listing_3b <- ae_master %>%
  filter(ae_date >= date_of_last_report) %>%
  filter(ae_related == 0) %>%
  arrange(ae_date) %>%
  select(ae_date, Related, Outcome, Severity, `SOC and Preferred Term`, ae_dsmc_summary) %>%
  rename("Date" = ae_date, "Summary" = ae_dsmc_summary) 



listing_3b %>% 
  flextable() %>% 
  align(align = "center", part = "header") %>%
  add_header_lines(., paste0("Adverse Events Not Related to the Intervention Since Date of Last Report (",date_of_last_report,")")) %>% 
  theme_booktabs() %>%
  set_table_properties(., layout = "autofit", width = 1)


```

\newpage

## Listing 6a: All Adverse Events

Date as of: `r date_as_of`

\newline

Date of report: `r format(Sys.time(), '%b %d, %Y')`

\newline

```{r listing_4a, echo=FALSE, warning=FALSE, message=FALSE}

listing_4a <- ae_master %>%
  rename("Date" = ae_date) %>%
  select(Date, "SOC and Preferred Term", Related, Severity, Serious, Outcome) %>%
  arrange(Date)


listing_4a %>% 
  flextable() %>% 
  align(align = "center", part = "header") %>%
  add_header_lines(., "All Adverse Events") %>% 
  theme_booktabs() %>%
  set_table_properties(., layout = "autofit", width = 1)


```

\newpage

